{"version":3,"file":"websurface.modern.js","sources":["../src/DOMContext.ts","../src/constants.ts","../src/DOMElement.ts","../src/websurface.ts"],"sourcesContent":["import { PerspectiveCamera, Quaternion, Scene, Vector3 } from 'three';\r\nimport { CSS3DRenderer } from 'three/examples/jsm/renderers/CSS3DRenderer';\r\nimport { cssFactor } from './constants';\r\n\r\nexport class DOMContext {\r\n  /**\r\n   * Whether to enable the `DOMContext` and its projection. Default is `true.`\r\n   */\r\n  enabled: boolean;\r\n  /**\r\n   * Renderer used for rendering the DOM\r\n   */\r\n  cssRenderer: CSS3DRenderer;\r\n  /**\r\n   * Target DOM element to render to\r\n   */\r\n  domElement: HTMLElement;\r\n  /**\r\n   * Camera used for CSS projection\r\n   */\r\n  cssCamera: PerspectiveCamera;\r\n  /**\r\n   * Parent camera used to sync with WebGL\r\n   */\r\n  camera: PerspectiveCamera;\r\n  //@custom\r\n  websurfaceEntity: any;\r\n  /**\r\n   * CSS scene used to contain CSS projections\r\n   */\r\n  cssScene: Scene;\r\n\r\n  /**\r\n   * DOM context instance\r\n   * @param camera  A perspective camera instance to draw from\r\n   */\r\n  constructor(camera: PerspectiveCamera, websurfaceEntity: any) {\r\n    //@custom\r\n    this.websurfaceEntity = websurfaceEntity;\r\n\r\n    // Set default settings\r\n    this.enabled = true;\r\n\r\n    // Init renderer\r\n    this.cssRenderer = new CSS3DRenderer();\r\n    this.domElement = this.cssRenderer.domElement;\r\n\r\n    //@custom click detection for leaving websurface\r\n    const div = document.createElement('div');\r\n    div.style.position = 'fixed';\r\n    div.style.top = '0';\r\n    div.style.width = '100%';\r\n    div.style.height = '100%';\r\n    div.style.zIndex = '-1';\r\n    this.domElement.appendChild(div);\r\n\r\n    div.addEventListener('click', function (event) {\r\n      websurfaceEntity.sceneEl.style.zIndex = 2;\r\n    });\r\n\r\n    // Init camera\r\n    this.cssCamera = new PerspectiveCamera(camera.fov, camera.aspect, camera.near * cssFactor, camera.far * cssFactor);\r\n    this.camera = camera;\r\n\r\n    // Init scene\r\n    this.cssScene = new Scene();\r\n\r\n    // Bind update\r\n    this.update = this.update.bind(this);\r\n  }\r\n\r\n  /**\r\n   * Resizes the DOM context's renderer and camera\r\n   * @param width Target width\r\n   * @param height Target height\r\n   */\r\n  setSize(width: number, height: number) {\r\n    this.cssRenderer.setSize(width, height);\r\n    this.cssCamera.aspect = width / height;\r\n    this.cssCamera.updateProjectionMatrix();\r\n  }\r\n\r\n  /**\r\n   * Updates the DOM context's renderer and camera states\r\n   */\r\n  update() {\r\n    //@custom\r\n    let camPos = new Vector3();\r\n    let camQuat = new Quaternion();\r\n    let camScale = new Vector3();\r\n    this.camera.matrixWorld.decompose(camPos, camQuat, camScale);\r\n    // Sync CSS camera with WebGL camera\r\n    this.cssCamera.quaternion.copy(camQuat);\r\n    this.cssCamera.position.copy(camPos).multiplyScalar(cssFactor);\r\n\r\n    // Render projection\r\n    this.cssRenderer.render(this.cssScene, this.cssCamera);\r\n  }\r\n}\r\n","/**\r\n * Useful for projecting to scale high-resolution DOM elements\r\n */\r\nexport const cssFactor = 100;\r\n","import { Mesh, PlaneGeometry, MeshBasicMaterial, NoBlending, DoubleSide, Vector3, Box3, Color } from 'three';\r\nimport { CSS3DObject } from 'three/examples/jsm/renderers/CSS3DRenderer';\r\nimport { DOMContext } from './DOMContext';\r\nimport { cssFactor } from './constants';\r\n\r\nexport class DOMElement extends Mesh {\r\n  /**\r\n   * The active `DOMContext` to draw on\r\n   */\r\n  context: DOMContext;\r\n  /**\r\n   * The projected 2D DOM element\r\n   */\r\n  domElement: HTMLElement;\r\n  /**\r\n   * DOM element aspect artio\r\n   */\r\n  aspectRatio: number;\r\n  /**\r\n   * DOM element width\r\n   */\r\n  elementWidth: number;\r\n  /**\r\n   * DOM element height\r\n   */\r\n  elementHeight: number;\r\n  /**\r\n   * 3D projection width\r\n   */\r\n  width: number;\r\n  /**\r\n   * 3D projection height\r\n   */\r\n  height: number;\r\n  /**\r\n   * The projecting 3D object\r\n   */\r\n  cssObject: CSS3DObject;\r\n  //@custom\r\n  cssObjectInitialScale: Vector3;\r\n  oldScaleFactor: Vector3;\r\n  /**\r\n   * Internal `Vector3` for WebGL size/scale calculations\r\n   */\r\n  size: Vector3;\r\n  /**\r\n   * Internal `Box` used for bounding box calculations\r\n   */\r\n  box: Box3;\r\n\r\n  /**\r\n   * DOM element that is projected into 3D space\r\n   * @param context A DOM context instance to draw on\r\n   * @param domElement A DOM element to project\r\n   * @param options DOM element options\r\n   * @param options.elementWidth DOM element width\r\n   * @param options.width 3D plane width\r\n   * @param options.height 3D plane height\r\n   */\r\n  constructor(\r\n    context: DOMContext,\r\n    domElement: HTMLElement,\r\n    width: number,\r\n    height: number,\r\n    { elementWidth = 1280 } = {}\r\n  ) {\r\n    // Create portal mesh\r\n    const geometry = new PlaneGeometry(width, height);\r\n    const material = new MeshBasicMaterial({\r\n      opacity: 0,\r\n      blending: NoBlending,\r\n      side: DoubleSide,\r\n      color: new Color(0, 0, 0),\r\n    });\r\n    super(geometry, material);\r\n\r\n    // Expose params\r\n    this.context = context;\r\n    this.domElement = domElement;\r\n    this.aspectRatio = height / width;\r\n    this.elementWidth = elementWidth;\r\n    this.elementHeight = this.elementWidth * this.aspectRatio;\r\n    this.width = width;\r\n    this.height = height;\r\n\r\n    // Set initial size\r\n    this.resizeElement();\r\n\r\n    // Init 3D DOM\r\n    this.cssObject = new CSS3DObject(this.domElement);\r\n    this.cssObject.scale.multiplyScalar(cssFactor / (this.elementWidth / this.width));\r\n    //@custom\r\n    this.cssObjectInitialScale = this.cssObject.scale;\r\n\r\n    // Init helpers\r\n    this.size = new Vector3();\r\n    this.box = new Box3();\r\n\r\n    // Init events\r\n    this.addEventListener('added', this.handleAdded);\r\n    this.addEventListener('removed', this.handleRemoved);\r\n\r\n    // Bind update\r\n    this.update = this.update.bind(this);\r\n  }\r\n\r\n  /**\r\n   * Adds the current cssObject to the scene\r\n   */\r\n  handleAdded() {\r\n    this.context.cssScene.add(this.cssObject);\r\n  }\r\n\r\n  /**\r\n   * Removes the current cssObject from the scene\r\n   */\r\n  handleRemoved() {\r\n    this.context.cssScene.remove(this.cssObject);\r\n  }\r\n\r\n  /**\r\n   * Resizes DOM element to sync with projection\r\n   */\r\n  resizeElement() {\r\n    this.domElement.style.width = `${this.elementWidth}px`;\r\n    this.domElement.style.height = `${this.elementHeight}px`;\r\n  }\r\n\r\n  /**\r\n   * Updates the projected DOM element\r\n   * @param domElement A DOM element to project\r\n   */\r\n  setElement(domElement: HTMLElement) {\r\n    // Cleanup previous element\r\n    if (this.domElement.parentNode) {\r\n      this.domElement.parentNode.removeChild(this.domElement);\r\n    }\r\n\r\n    // Set new element\r\n    this.domElement = domElement;\r\n    this.cssObject.element = domElement;\r\n\r\n    // Reset element size\r\n    this.resizeElement();\r\n  }\r\n\r\n  /**\r\n   * Updates the DOM element and its projection states\r\n   */\r\n  //@custom\r\n  update(obj: any) {\r\n    // Sync CSS properties with WebGL mesh\r\n    this.cssObject.quaternion.copy(obj.quaternion);\r\n    this.cssObject.position.copy(obj.position).multiplyScalar(cssFactor);\r\n\r\n    // Calculate CSS scale factor\r\n    this.box.setFromObject(this).getSize(this.size);\r\n    const scaleFactor = obj.scale;\r\n\r\n    // Sync CSS scale with WebGL projection\r\n    if (this.oldScaleFactor != scaleFactor) {\r\n      this.oldScaleFactor = scaleFactor;\r\n      this.cssObject.scale.set(\r\n        this.cssObjectInitialScale.x,\r\n        this.cssObjectInitialScale.y,\r\n        this.cssObjectInitialScale.z\r\n      );\r\n      this.cssObject.scale.multiply(scaleFactor);\r\n    }\r\n\r\n    this.cssObject.visible = obj.visible;\r\n  }\r\n\r\n  /**\r\n   * Disposes WebGL and DOM elements\r\n   */\r\n  dispose() {\r\n    // Cleanup events\r\n    this.removeEventListener('added', this.handleAdded);\r\n    this.removeEventListener('removed', this.handleRemoved);\r\n\r\n    // Cleanup DOM\r\n    this.domElement.remove();\r\n\r\n    // Cleanup WebGL\r\n    this.geometry.dispose();\r\n    (this.material as MeshBasicMaterial).dispose();\r\n  }\r\n}\r\n","//uses a modified version of https://github.com/CodyJasonBennett/three-dom-elements\r\nimport { DOMContext } from './DOMContext';\r\nimport { DOMElement } from './DOMElement';\r\n\r\nexport const component = AFRAME.registerComponent('websurface', {\r\n  schema: {\r\n    url: { default: 'https://aframe.io' },\r\n    width: { default: 1 },\r\n    height: { default: 0.75 },\r\n    frameSkips: { default: 1 },\r\n    autoSceneStyling: { default: true },\r\n  },\r\n\r\n  init: function () {\r\n    const el = this.el;\r\n    const data = this.data;\r\n\r\n    if (data.autoSceneStyling == true) {\r\n      el.sceneEl.style.position = 'absolute';\r\n    }\r\n\r\n    data.mouseHasLeftScreen = true;\r\n\r\n    //geometry for click detection\r\n    el.setAttribute('geometry', `primitive:plane; width:${data.width}; height:${data.height};`);\r\n\r\n    el.addEventListener('click', function () {\r\n      if (data.mouseHasLeftScreen == false) return;\r\n\r\n      document.exitPointerLock();\r\n      el.sceneEl.style.zIndex = -2;\r\n\r\n      data.mouseHasLeftScreen = false;\r\n    });\r\n\r\n    el.addEventListener('mouseleave', function () {\r\n      data.mouseHasLeftScreen = true;\r\n    });\r\n\r\n    el.sceneEl.addEventListener('cam-loaded', function () {\r\n      const iframe = document.createElement('iframe');\r\n      iframe.setAttribute('src', data.url);\r\n      iframe.style.border = 'none';\r\n\r\n      const camera = el.sceneEl.camera;\r\n      const context = new DOMContext(camera, el);\r\n      context.setSize(window.innerWidth, window.innerHeight);\r\n      document.body.appendChild(context.domElement);\r\n\r\n      const element = new DOMElement(context, iframe, data.width, data.height);\r\n      el.object3D.add(element);\r\n\r\n      data.context = context;\r\n      data.element = element;\r\n\r\n      window.addEventListener('resize', () => {\r\n        context.setSize(window.innerWidth, window.innerHeight);\r\n      });\r\n    });\r\n\r\n    data.frames = 0;\r\n    data.isCamLoaded = false;\r\n  },\r\n\r\n  tick: function () {\r\n    const el = this.el;\r\n    const data = this.data;\r\n\r\n    if (data.isCamLoaded == false) {\r\n      const camera = el.sceneEl.camera;\r\n      if (camera) {\r\n        this.el.emit('cam-loaded');\r\n        data.isCamLoaded = true;\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    const context = data.context;\r\n    const element = data.element;\r\n\r\n    if (data.frames % data.frameSkips == 0) {\r\n      if (context) {\r\n        context.update();\r\n      }\r\n      if (element) {\r\n        element.update(el.object3D);\r\n      }\r\n    }\r\n\r\n    data.frames++;\r\n  },\r\n});\r\n"],"names":["DOMContext","constructor","camera","websurfaceEntity","this","enabled","cssRenderer","CSS3DRenderer","domElement","div","document","createElement","style","position","top","width","height","zIndex","appendChild","addEventListener","event","sceneEl","cssCamera","PerspectiveCamera","fov","aspect","near","far","cssScene","Scene","update","bind","setSize","updateProjectionMatrix","camPos","Vector3","camQuat","Quaternion","camScale","matrixWorld","decompose","quaternion","copy","multiplyScalar","render","DOMElement","Mesh","context","elementWidth","super","PlaneGeometry","MeshBasicMaterial","opacity","blending","NoBlending","side","DoubleSide","color","Color","aspectRatio","elementHeight","resizeElement","cssObject","CSS3DObject","scale","cssObjectInitialScale","size","box","Box3","handleAdded","handleRemoved","add","remove","setElement","parentNode","removeChild","element","obj","setFromObject","getSize","scaleFactor","oldScaleFactor","set","x","y","z","multiply","visible","dispose","removeEventListener","geometry","material","component","AFRAME","registerComponent","schema","url","default","frameSkips","autoSceneStyling","init","el","data","mouseHasLeftScreen","setAttribute","exitPointerLock","iframe","border","window","innerWidth","innerHeight","body","object3D","frames","isCamLoaded","tick","emit"],"mappings":"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"}